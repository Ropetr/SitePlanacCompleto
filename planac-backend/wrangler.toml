# Configuração do Cloudflare Workers
# Documentação: https://developers.cloudflare.com/workers/wrangler/configuration/

name = 'planac-backend-api'
main = "src/index.js"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# Variáveis de ambiente (públicas)
[vars]
ENVIRONMENT = "production"
API_VERSION = "1.0.0"

# ============================================
# BANCO DE DADOS - Cloudflare D1
# ============================================
[[d1_databases]]
binding = "DB" # Acessível via env.DB
database_name = "planac-database"
database_id = "ce7c52fc-7aa4-4539-ac80-081d8ee16cc2" # Será gerado quando criar o banco
# Comando: wrangler d1 create planac-database

# ============================================
# STORAGE - Cloudflare R2 (Imagens)
# ============================================
[[r2_buckets]]
binding = "R2_IMAGES" # Acessível via env.R2_IMAGES
bucket_name = "planac-images"
preview_bucket_name = "planac-images-preview"

# ============================================
# CACHE - Cloudflare KV
# ============================================
[[kv_namespaces]]
binding = "KV_CACHE"
id = "e8d8225292f9453db316a0a6566dec7d"

[[kv_namespaces]]
binding = "KV_SESSIONS"
id = "719ad6603daa4043999069240aa9deed"

[[kv_namespaces]]
binding = "SITE_CACHE" # Para cache do header.html e invalidação
id = "e8d8225292f9453db316a0a6566dec7d" # Usando mesmo KV do cache

# ============================================
# VARIÁVEIS SECRETAS (não commitar!)
# ============================================
# Configure via: wrangler secret put NOME_DA_SECRET
# Exemplo: wrangler secret put JWT_SECRET

# Secrets necessárias:
# - JWT_SECRET
# - JWT_REFRESH_SECRET
# - ADMIN_EMAIL
# - ADMIN_PASSWORD
# - GITHUB_TOKEN (para disparar GitHub Actions - rebuild automático)

# ============================================
# CONFIGURAÇÕES DE DEPLOY
# ============================================
[build]
command = ""

# Rotas personalizadas (opcional)
# Descomente quando o domínio estiver na conta Cloudflare
# [[routes]]
# pattern = "api.planacdivisorias.com.br/*"
# zone_name = "planacdivisorias.com.br"

# Limite de CPU (100ms grátis por requisição)
[limits]
cpu_ms = 50

# ============================================
# AMBIENTE DE DESENVOLVIMENTO
# ============================================
[env.development]
name = "planac-backend-api-dev"
vars = { ENVIRONMENT = "development" }

[[env.development.d1_databases]]
binding = "DB"
database_name = "planac-database-dev"
database_id = "SEU_DEV_DATABASE_ID"

[[env.development.r2_buckets]]
binding = "R2_IMAGES"
bucket_name = "planac-images-dev"

# ============================================
# AMBIENTE DE STAGING
# ============================================
[env.staging]
name = "planac-backend-api-staging"
vars = { ENVIRONMENT = "staging" }

[[env.staging.d1_databases]]
binding = "DB"
database_name = "planac-database-staging"
database_id = "SEU_STAGING_DATABASE_ID"

[[env.staging.r2_buckets]]
binding = "R2_IMAGES"
bucket_name = "planac-images-staging"
